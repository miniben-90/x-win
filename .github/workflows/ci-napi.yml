name: Build & Test & publich node package "@miniben90/x-win"

env:
  DEBUG: napi:*
  APP_NAME: x-win
  MACOSX_DEPLOYMENT_TARGET: '10.13'
  CARGO_INCREMENTAL: '1'

on:
  push:
    branches:
      - main
    tags:
      - 'napi-*.*.*'
      - 'napi-v*.*.*'
    paths-ignore:
      - '**/*.md'
      - LICENSE
      - '**/*.gitignore'
      - .editorconfig
      - docs/**
  pull_request: null
  # release:
  #   types: [published]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

#permissions:
#  id-token: write
#  contents: write

jobs:
  #
  # Part Bluid
  #
  lint:
    defaults:
      run:
        working-directory: ${{ github.workspace }}/x-win-rs
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        settings:
          - name: Darwin
            target: x86_64-apple-darwin
          - name: Windows
            target: x86_64-pc-windows-msvc
          - name: Linux GNU
            target: x86_64-unknown-linux-gnu
    name: Check quality of code for ${{ matrix.settings.name }} (${{ matrix.settings.target }})
    steps:
      # Checkout repo
      - uses: actions/checkout@v5
      # Config cache
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo
            ${{ github.workspace }}/.xwin
          key: ${{ matrix.settings.target }}-cargo-cache
      # Configure Cargo/Rustup paths ONLY when running under act to avoid rename file error
      - name: Configure Rust paths for act
        if: ${{ env.ACT }}
        run: |
          mkdir -p /tmp/cargo /tmp/rustup
          echo "CARGO_HOME=/tmp/cargo" >> $GITHUB_ENV
          echo "RUSTUP_HOME=/tmp/rustup" >> $GITHUB_ENV
          echo "/tmp/cargo/bin" >> $GITHUB_PATH
      # Install lib dev required for compilation of the project
      - name: Install libx11 & libxcb for building
        if: startsWith(matrix.settings.target, 'x86_64-unknown-linux')
        run: bash ${{ github.workspace }}/.github/docker-install-deps.sh
      # Install Rust toolchain with clippy and rustfmt
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.settings.target }}
      # Add clippy and rustfmt
      - name: Install Clippy and Rustfmt component
        run: rustup component add clippy rustfmt
      # Run Format rust code
      - name: Format Rust Code
        run: cargo fmt -- --check
      # Lint the code with clippy
      - name: Lint the code with Clippy (Darwin)
        run: cargo clippy --all-features --target ${{ matrix.settings.target }} -- -D warnings

  #
  # Build part
  #

  build:
    needs:
      - lint
    strategy:
      fail-fast: false
      matrix:
        node-version: [24]
        settings:
          - name: Darwin x64
            target: x86_64-apple-darwin
            host: macos-latest
          - name: Darwin Silicon
            target: aarch64-apple-darwin
            host: macos-latest
          - name: Windows x64
            target: x86_64-pc-windows-msvc
            flags: '-x'
          - name: Windows i686
            target: i686-pc-windows-msvc
            flags: '-x'
          - name: Windows ARM64
            target: aarch64-pc-windows-msvc
            flags: '-x'
          - name: Linux GNU x64
            target: x86_64-unknown-linux-gnu
            flags: '--use-napi-cross'
            # glibc: '2.18'
          - name: Linux MUSL x64
            target: x86_64-unknown-linux-musl
            flags: '--use-napi-cross'
    runs-on: ${{ matrix.settings.host || 'ubuntu-latest' }}
    name: Build ${{ matrix.settings.name }} (${{ matrix.settings.target }}) - node@${{ matrix.node-version }}
    steps:
      # Checkout repo
      - uses: actions/checkout@v5

      # Configure Cargo/Rustup paths ONLY when running under act to avoid rename file error
      - name: Configure Rust paths for act
        if: ${{ env.ACT }}
        run: |
          mkdir -p /tmp/cargo /tmp/rustup
          echo "CARGO_HOME=/tmp/cargo" >> $GITHUB_ENV
          echo "RUSTUP_HOME=/tmp/rustup" >> $GITHUB_ENV
          echo "/tmp/cargo/bin" >> $GITHUB_PATH

      # Install lib dev required for compilation of the project
      - name: Install libx11 & libxcb for building
        if: startsWith(matrix.settings.target, 'x86_64-unknown-linux')
        run: bash ${{ github.workspace }}/.github/docker-install-deps.sh

      # Cargo cache
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo
            ${{ github.workspace }}/.xwin
            ~/.napi-rs
            ./target
          key: ${{ matrix.settings.target }}-cargo-cache

      # Installing Rust toolchain with target
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.settings.target }}

      # Copy XCB lib for zig build
      - name: Copy XCB into napi cross sysroot
        if: ${{ matrix.settings.target == 'x86_64-unknown-linux-gnu' }}
        run: |
          set -eux
          TOOLCHAIN_DIR="$(rustc --print sysroot)/lib/rustlib/x86_64-unknown-linux-gnu/lib"
          echo "Injecting libxcb into $TOOLCHAIN_DIR"
          mkdir -p "$TOOLCHAIN_DIR"
          cp -a /usr/lib/x86_64-linux-gnu/libxcb.so* "$TOOLCHAIN_DIR/" || true
          ls -l "$TOOLCHAIN_DIR" | grep libxcb || true

      # Setup node with yarn cache
      - name: Install node ${{ matrix.node-version }}
        uses: actions/setup-node@v5
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'yarn'

      # Install ziglang for crossbuild
      - name: Install ziglang
        uses: mlugg/setup-zig@v2
        with:
          version: 0.14.1

      # Install cargo toolchains
      - name: Install cargo toolchains
        if: ${{ matrix.settings.host != 'macos-latest' }}
        uses: taiki-e/install-action@v2
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tool: cargo-zigbuild,cargo-xwin

      # Install deps
      - name: Install dependencies
        run: yarn install

      # Build for target
      - name: Build ${{ matrix.settings.target }}${{ matrix.settings.glibc && format('.{0}', matrix.settings.glibc) || '' }}
        run: yarn build --target ${{ matrix.settings.target }}${{ matrix.settings.glibc && format('.{0}', matrix.settings.glibc) || '' }} ${{ matrix.settings.flags }}
        env:
          XWIN_CACHE_DIR: ${{ github.workspace }}/.xwin

      # Upload artifact for the next steps (macos and test)
      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: bindings-${{ matrix.settings.target }}
          path: ${{ github.workspace }}/${{ env.APP_NAME }}.*.node
          if-no-files-found: error

  test:
    name: Test bindings on ${{ matrix.settings.target }} (${{ matrix.settings.host }}) - node@${{ matrix.node-version }}
    needs:
      - lint
      - build
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: windows-latest
            target: x86_64-pc-windows-msvc

          # - host: windows-latest
          #   target: i686-pc-windows-msvc
          #   architecture: 'x86'

          - host: macos-latest
            target: aarch64-apple-darwin

          - host: macos-latest
            target: x86_64-apple-darwin
            architecture: 'x64'

          - host: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            image: miniben90/ubuntu-dummy-desktop:latest

        node-version: [18, 20, 22, 24]

    runs-on: ${{ matrix.settings.host }}
    steps:
      - uses: actions/checkout@v5

      # Setup yarn to run as x86_64 for darwin arm64
      - name: Setup node x86_64
        if: ${{ matrix.settings.target == 'x86_64-apple-darwin' }}
        run: arch -x86_64 zsh

      # Setup node version from matrix.node and install deps
      - name: Setup node
        if: ${{ !matrix.settings.image }}
        uses: actions/setup-node@v5
        with:
          node-version: ${{ matrix.node-version }}
          check-latest: true
          cache: yarn
          architecture: ${{ matrix.settings.architecture || '' }}

      # Setup yarn with ia32 for windows x86
      - name: Setup node x86
        if: ${{ matrix.settings.target == 'i686-pc-windows-msvc' }}
        run: yarn config set supportedArchitectures.cpu "ia32"
        shell: bash

      # Install deps
      - name: Install dependencies
        run: yarn install

      # Download artifacts
      - name: Download artifacts
        uses: actions/download-artifact@v6
        with:
          name: bindings-${{ matrix.settings.target }}
          path: .

      - name: Open finder to have an active window (MacOS)
        if: ${{ matrix.settings.host == 'macos-latest' }}
        run: open .

      - name: Open explorer to have an active window (windows)
        if: ${{ matrix.settings.host == 'windows-latest' }}
        run: explorer .

      - name: Test bindings
        if: ${{ !matrix.settings.image }}
        run: yarn test

      - name: Test bindings on docker
        if: ${{ matrix.settings.image }}
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ matrix.settings.image }}
          options: --user 0:0 -v ${{ github.workspace }}/.github/docker-ubuntu-install.sh:/usr/local/docker-ubuntu-install.sh -v ${{ github.workspace }}/.github/download-firefox.sh:/usr/local/download-firefox.sh -v ${{ github.workspace }}:/work -w /work
          run: |
            Xvfb :0 &
            sleep 1
            gpg-agent --daemon
            sleep 1
            xfce4-session &
            sleep 1
            sh /usr/local/docker-ubuntu-install.sh ${{ matrix.node-version }}
            cd /work
            yarn test

  # Generate universal for macos

  universal-macOS:
    name: Build universal macOS binary
    needs:
      - lint
      - build
      - test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v5
      - name: Setup node
        uses: actions/setup-node@v5
        with:
          node-version: 24
          check-latest: true
          cache: yarn
      - name: Install dependencies
        run: yarn install
      - name: Download macOS x64 artifact
        uses: actions/download-artifact@v6
        with:
          name: bindings-x86_64-apple-darwin
          path: .
      - name: Download macOS arm64 artifact
        uses: actions/download-artifact@v6
        with:
          name: bindings-aarch64-apple-darwin
          path: .
      - name: Combine binaries
        run: yarn universalize
      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: bindings-universal-apple-darwin
          path: ${{ github.workspace }}/${{ env.APP_NAME }}.*.node
          if-no-files-found: error

  publish:
    if: ${{ startsWith(github.ref, 'refs/tags/') && startsWith(github.ref_name, 'napi-') }}
    name: Publish ${{ github.ref_name }} (${{ github.ref }})
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      TAG: ${{ github.ref_name }}
    needs:
      - lint
      - build
      - test
      - universal-macOS
    steps:
      - uses: actions/checkout@v5

      # Setup node for publishing on npmjs
      - name: Setup node
        uses: actions/setup-node@v5
        with:
          node-version: 24
          check-latest: true
          cache: yarn
          registry-url: 'https://registry.npmjs.org'
          scope: '@miniben90'

          # Install dependencies
      - name: Install dependencies
        run: yarn install

      # Update package.json and Cargo.toml version
      - name: Set version to package.json
        run: node .scripts/before-publish.cjs

      # Cleanup package.json before publishing it
      # - name: Cleanup package.json before publishing
      #   run: node .scripts/cleanup-package.cjs

      # Download artifacts from build part
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts

      # Upload artifacts to the release tag asset
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**

      # Move artifacts at there places
      - name: Run napi artifacts to struct deps
        run: yarn artifacts

      # Publish packages on npmjs
      - name: Publish packages
        run: npm publish --access public
